<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brookwood / IT Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@700;800&family=Lora:ital@1&family=Plus+Jakarta+Sans:wght@600;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #f4f1ec; color: #1a1a1a; font-family: 'DM Mono', 'Courier New', monospace; min-height: 100vh; }
    a { text-decoration: none; }
    button { cursor: pointer; font-family: inherit; }
    select, input { font-family: inherit; }

    #header {
      border-bottom: 1px solid #e0dbd2;
      padding: 22px 32px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: #f4f1ec;
      z-index: 10;
      flex-wrap: wrap;
      gap: 12px;
    }
    #header-left { display: flex; flex-direction: column; gap: 4px; }
    #title { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800; letter-spacing: -0.02em; color: #1a1a1a; }
    #title span { color: #c0622f; }
    #date { font-size: 11px; color: #aaa; letter-spacing: 0.03em; font-weight: 300; }
    #filters { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
    #filters label { font-size: 10px; color: #aaa; margin-right: 4px; letter-spacing: 0.05em; }
    .filter-btn {
      background: transparent;
      border: 1px solid #d8d3ca;
      color: #888;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.06em;
      transition: all 0.15s;
    }
    .filter-btn:hover { border-color: #bbb; color: #555; }
    .filter-btn.active { color: #fff; border-color: transparent; }

    #quote-bar {
      background: #fff;
      border-bottom: 1px solid #e0dbd2;
      padding: 10px 32px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    #quote-mark { font-family: 'Lora', Georgia, serif; font-size: 28px; color: #e0dbd2; line-height: 1; flex-shrink: 0; margin-top: -4px; }
    #quote-text { font-family: 'Lora', Georgia, serif; font-style: italic; font-size: 13px; color: #777; flex: 1; line-height: 1.5; }
    #quote-author { font-size: 10px; color: #bbb; white-space: nowrap; letter-spacing: 0.04em; }

    #grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1px;
      background: #e0dbd2;
    }
    .column {
      background: #f4f1ec;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 300px;
    }
    .col-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--cat-color);
      cursor: grab;
      user-select: none;
    }
    .col-header:active { cursor: grabbing; }
    .col-header-left { display: flex; align-items: center; gap: 7px; }
    .col-icon { font-size: 14px; }
    .col-label { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.06em; color: #333; text-transform: uppercase; }
    .col-count {
      font-size: 10px; color: #fff; font-weight: 700;
      width: 20px; height: 20px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }

    .card {
      background: #fff;
      border: 1px solid #e8e3da;
      border-radius: 8px;
      padding: 11px 13px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      transition: box-shadow 0.2s, border-color 0.2s;
      cursor: grab;
    }
    .card:hover { border-color: #d0c9be; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .card.dragging { opacity: 0.4; cursor: grabbing; }
    .card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
    .card-title { color: #1a1a1a; font-size: 12px; font-weight: 500; line-height: 1.4; flex: 1; }
    .card-title a { color: #1a1a1a; transition: color 0.15s; }
    .card-note { color: #999; font-size: 11px; font-style: italic; }
    .card-nolink { color: #ccc; font-size: 11px; }
    .status-badge { font-size: 9px; font-weight: 700; letter-spacing: 0.07em; padding: 2px 7px; border-radius: 20px; white-space: nowrap; }
    .card-links { display: flex; flex-direction: column; gap: 3px; }
    .edit-btn { background: none; border: none; color: #ccc; font-size: 10px; padding: 0; margin-top: 1px; align-self: flex-start; transition: color 0.15s; }
    .edit-btn:hover { color: #888; }

    .edit-form, .add-form {
      background: #fff; border: 1px solid #e8e3da; border-radius: 8px;
      padding: 12px; display: flex; flex-direction: column; gap: 7px;
    }
    .form-input {
      background: #f9f7f4; border: 1px solid #e0dbd2; color: #1a1a1a;
      padding: 6px 10px; border-radius: 5px; font-size: 12px; width: 100%;
      outline: none; transition: border-color 0.15s;
    }
    .form-input:focus { border-color: #bbb; }
    .form-input.small { font-size: 11px; color: #666; }
    .form-row { display: flex; gap: 7px; }
    .btn-save { flex: 1; color: #fff; border: none; padding: 7px; border-radius: 5px; font-weight: 700; font-size: 11px; }
    .btn-cancel { background: #f0ede8; color: #888; border: 1px solid #e0dbd2; padding: 7px 12px; border-radius: 5px; font-size: 11px; }
    .btn-delete { background: #fff1f1; color: #e05555; border: 1px solid #f5c6c6; padding: 7px 10px; border-radius: 5px; font-size: 11px; }

    .add-btn {
      background: none; border: 1px dashed #d8d3ca; color: #bbb;
      border-radius: 8px; padding: 9px; font-size: 10px; letter-spacing: 0.05em;
      margin-top: auto; width: 100%; transition: all 0.15s;
    }
    .add-btn:hover { color: var(--cat-color); border-color: var(--cat-color); background: var(--cat-color-bg); }

    .drop-indicator { height: 3px; border-radius: 2px; background: #c0622f; margin: -2px 0; opacity: 0; transition: opacity 0.1s; }
    .drop-indicator.visible { opacity: 1; }

    .column.col-dragging { opacity: 0.4; }
    .column.col-drop-left  { box-shadow: -3px 0 0 #c0622f; }
    .column.col-drop-right { box-shadow:  3px 0 0 #c0622f; }

    #footer {
      padding: 12px 32px; border-top: 1px solid #e0dbd2;
      background: #f4f1ec; display: flex; justify-content: space-between; align-items: center;
    }
    #footer span { font-size: 10px; color: #bbb; letter-spacing: 0.04em; }
  </style>
</head>
<body>

<div id="header">
  <div id="header-left">
    <div id="title">BROOKWOOD <span>/ IT</span></div>
    <div id="date"></div>
  </div>
  <div id="filters"><label>FILTER</label></div>
</div>

<div id="quote-bar">
  <div id="quote-mark">"</div>
  <div id="quote-text"></div>
  <div id="quote-author"></div>
</div>

<div id="grid"></div>

<div id="footer">
  <span id="doc-count"></span>
  <span>DRAG HEADER TO REORDER COLUMNS · DRAG CARD TO REORDER · CLICK EDIT TO UPDATE</span>
</div>

<script>
const QUOTES = [
  ["The art of teaching is the art of assisting discovery.", "Mark Van Doren"],
  ["Technology is best when it brings people together.", "Matt Mullenweg"],
  ["Do not wait to strike till the iron is hot, but make it hot by striking.", "W.B. Yeats"],
  ["The secret of getting ahead is getting started.", "Mark Twain"],
  ["Small deeds done are better than great deeds planned.", "Peter Marshall"],
  ["An ounce of action is worth a ton of theory.", "Ralph Waldo Emerson"],
  ["Education is not the filling of a pail, but the lighting of a fire.", "W.B. Yeats"],
  ["The best way to predict the future is to invent it.", "Alan Kay"],
  ["Simplicity is the ultimate sophistication.", "Leonardo da Vinci"],
  ["It always seems impossible until it's done.", "Nelson Mandela"],
  ["The function of leadership is to produce more leaders, not more followers.", "Ralph Nader"],
  ["In the middle of difficulty lies opportunity.", "Albert Einstein"],
  ["First, solve the problem. Then, write the code.", "John Johnson"],
  ["Any sufficiently advanced technology is indistinguishable from magic.", "Arthur C. Clarke"],
  ["The measure of intelligence is the ability to change.", "Albert Einstein"],
  ["Strive not to be a success, but rather to be of value.", "Albert Einstein"],
  ["The only way to do great work is to love what you do.", "Steve Jobs"],
  ["Make things as simple as possible, but not simpler.", "Albert Einstein"],
  ["Learning never exhausts the mind.", "Leonardo da Vinci"],
  ["Tell me and I forget. Teach me and I remember. Involve me and I learn.", "Benjamin Franklin"],
  ["The roots of education are bitter, but the fruit is sweet.", "Aristotle"],
  ["An investment in knowledge pays the best interest.", "Benjamin Franklin"],
  ["A good teacher can inspire hope, ignite the imagination, and instill a love of learning.", "Brad Henry"],
  ["Technology will not replace great teachers, but technology in the hands of great teachers can be transformational.", "George Couros"],
  ["The beautiful thing about learning is that no one can take it away from you.", "B.B. King"],
  ["You don't have to be great to start, but you have to start to be great.", "Zig Ziglar"],
  ["The capacity to learn is a gift; the ability to learn is a skill; the willingness to learn is a choice.", "Brian Herbert"],
  ["What we learn with pleasure we never forget.", "Alfred Mercier"],
  ["The goal of education is not to increase the amount of knowledge but to create the possibilities for a child to invent and discover.", "Jean Piaget"],
  ["The most powerful tool we have as developers is automation.", "Scott Hanselman"],
  ["Done is better than perfect.", "Sheryl Sandberg"],
  ["Every system is perfectly designed to get the results it gets.", "W. Edwards Deming"],
  ["Productivity is never an accident. It is always the result of a commitment to excellence.", "Paul J. Meyer"],
  ["We cannot solve our problems with the same thinking we used when we created them.", "Albert Einstein"],
  ["A ship in harbor is safe, but that is not what ships are for.", "John A. Shedd"],
  ["Focus on being productive instead of busy.", "Tim Ferriss"],
  ["The key is not to prioritize what's on your schedule, but to schedule your priorities.", "Stephen Covey"],
  ["Effort only fully releases its reward after a person refuses to quit.", "Napoleon Hill"],
  ["The secret of change is to focus all of your energy not on fighting the old, but on building the new.", "Socrates"],
  ["Start where you are. Use what you have. Do what you can.", "Arthur Ashe"],
  ["Excellence is not a destination but a continuous journey that never ends.", "Brian Tracy"],
  ["Great things are done by a series of small things brought together.", "Vincent Van Gogh"],
  ["The only limit to our realization of tomorrow is our doubts of today.", "Franklin D. Roosevelt"],
  ["Innovation distinguishes between a leader and a follower.", "Steve Jobs"],
  ["If you want to go fast, go alone. If you want to go far, go together.", "African Proverb"],
  ["Leadership is not about being in charge. It's about taking care of those in your charge.", "Simon Sinek"],
  ["You can't use up creativity. The more you use, the more you have.", "Maya Angelou"],
  ["The two most powerful warriors are patience and time.", "Leo Tolstoy"],
  ["Work smarter, not harder.", "Carl Barks"],
  ["Clarity is power.", "Tony Robbins"],
  ["Every expert was once a beginner.", "Helen Hayes"],
  ["Progress, not perfection.", "Unknown"],
  ["The details are not the details. They make the design.", "Charles Eames"],
  ["A problem well stated is a problem half solved.", "Charles Kettering"],
  ["Where all think alike, no one thinks very much.", "Walter Lippmann"],
  ["The best preparation for tomorrow is doing your best today.", "H. Jackson Brown Jr."],
  ["Knowing yourself is the beginning of all wisdom.", "Aristotle"],
  ["We are what we repeatedly do. Excellence, then, is not an act but a habit.", "Aristotle"],
  ["The mind is not a vessel to be filled, but a fire to be kindled.", "Plutarch"],
  ["Teach the children so it will not be necessary to teach the adults.", "Abraham Lincoln"],
  ["The future belongs to those who believe in the beauty of their dreams.", "Eleanor Roosevelt"],
];

const CATEGORIES_DEFAULT = [
  { id: "meetings",       label: "Tech Meeting Notes",  icon: "◈", color: "#E8924B" },
  { id: "planning",       label: "Tech Planning Docs",  icon: "◉", color: "#3BAA8F" },
  { id: "curriculum",     label: "Curriculum Review",   icon: "◐", color: "#8B6FD4" },
  { id: "infrastructure", label: "Infrastructure",      icon: "◼", color: "#4A90D9" },
  { id: "partners",       label: "Partner Docs",        icon: "◆", color: "#D95F5F" },
  { id: "support",        label: "Support",             icon: "◎", color: "#c0622f" },
];
let CATEGORIES = [...CATEGORIES_DEFAULT];

const STATUSES = ["Active", "Draft", "Waiting", "Review", "Done"];
const STATUS_STYLES = {
  Active:  { text: "#1d7a57", bg: "#e6f7f1", border: "#a8dfc7" },
  Draft:   { text: "#8a6200", bg: "#fff8e1", border: "#ffd97a" },
  Waiting: { text: "#c0392b", bg: "#fdf0ef", border: "#f5b7b1" },
  Review:  { text: "#6a4bc4", bg: "#f3f0ff", border: "#c9b8f0" },
  Done:    { text: "#999",    bg: "#f5f5f5", border: "#ddd"    },
};

const DEFAULT_DOCS = [
  { id: "1",  category: "meetings",       title: "IT Department Meeting Notes", url: "", status: "Active", note: "" },
  { id: "2",  category: "meetings",       title: "Leadership Meeting Notes",    url: "", status: "Active", note: "" },
  { id: "3",  category: "planning",       title: "Veracross Streamlining Plan", url: "", status: "Draft",  note: "" },
  { id: "4",  category: "planning",       title: "Vision Documentation",        url: "", status: "Draft",  note: "" },
  { id: "5",  category: "planning",       title: "Newsletter Planning",         url: "", status: "Active", note: "" },
  { id: "6",  category: "curriculum",     title: "Curriculum Review Tracker",   url: "", status: "Draft",  note: "" },
  { id: "7",  category: "curriculum",     title: "AI Integration Research",     url: "", status: "Active", note: "" },
  { id: "8",  category: "partners",       title: "3s Company — Contract",       url: "", status: "Active", note: "" },
  { id: "9",  category: "partners",       title: "3s Company — Invoices",       url: "", status: "Active", note: "" },
  { id: "10", category: "partners",       title: "SecureWon — Contract",        url: "", status: "Active", note: "" },
  { id: "11", category: "partners",       title: "SecureWon — Invoices",        url: "", status: "Waiting",note: "" },
  { id: "12", category: "partners",       title: "SecureWon — Projects",        url: "", status: "Active", note: "" },
  { id: "13", category: "infrastructure", title: "Network Infrastructure Doc",  url: "", status: "Draft",  note: "" },
  { id: "14", category: "infrastructure", title: "Device Inventory",            url: "", status: "Active", note: "" },
  { id: "15", category: "support",        title: "TPX",                         url: "", status: "Active", note: "" },
  { id: "16", category: "support",        title: "Printers",                    url: "", status: "Active", note: "" },
  { id: "17", category: "support",        title: "Wifi",                        url: "", status: "Active", note: "" },
  { id: "18", category: "support",        title: "Mosyle",                      url: "", status: "Active", note: "" },
  { id: "19", category: "support",        title: "Apple",                       url: "", status: "Active", note: "" },
  { id: "20", category: "support",        title: "ContentKeeper",               url: "", status: "Active", note: "" },
];

const STORAGE_KEY = "brookwood-it-dashboard";
let docs = [];
let filterStatus = "All";

function load() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    docs = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_DOCS));
  } catch { docs = JSON.parse(JSON.stringify(DEFAULT_DOCS)); }
  try {
    const savedCols = localStorage.getItem(STORAGE_KEY + "-cols");
    if (savedCols) {
      const order = JSON.parse(savedCols);
      CATEGORIES = order.map(id => CATEGORIES_DEFAULT.find(c => c.id === id)).filter(Boolean);
      CATEGORIES_DEFAULT.forEach(c => { if (!CATEGORIES.find(x => x.id === c.id)) CATEGORIES.push(c); });
    }
  } catch {}
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
  localStorage.setItem(STORAGE_KEY + "-cols", JSON.stringify(CATEGORIES.map(c => c.id)));
}

function setDate() {
  const d = new Date();
  document.getElementById("date").textContent = d.toLocaleDateString("en-US", { weekday: "long", month: "long", day: "numeric" }).toUpperCase();
}

function setQuote() {
  const d = new Date();
  const dayOfYear = Math.floor((d - new Date(d.getFullYear(), 0, 0)) / 86400000);
  const [text, author] = QUOTES[dayOfYear % QUOTES.length];
  document.getElementById("quote-text").textContent = text;
  document.getElementById("quote-author").textContent = "— " + author;
}

const FILTER_COLORS = { All: "#c0622f", Active: "#1d7a57", Draft: "#8a6200", Waiting: "#c0392b", Review: "#6a4bc4", Done: "#888" };

function buildFilters() {
  const container = document.getElementById("filters");
  ["All", ...STATUSES].forEach(s => {
    const btn = document.createElement("button");
    btn.className = "filter-btn" + (s === filterStatus ? " active" : "");
    btn.textContent = s.toUpperCase();
    btn.dataset.status = s;
    if (s === filterStatus) { btn.style.background = FILTER_COLORS[s]; }
    btn.addEventListener("click", () => { filterStatus = s; render(); });
    container.appendChild(btn);
  });
}

function updateFilters() {
  document.querySelectorAll(".filter-btn").forEach(btn => {
    const s = btn.dataset.status;
    const isActive = s === filterStatus;
    btn.classList.toggle("active", isActive);
    btn.style.background = isActive ? FILTER_COLORS[s] : "transparent";
    btn.style.borderColor = isActive ? "transparent" : "#d8d3ca";
    btn.style.color = isActive ? "#fff" : "#888";
  });
}

let draggedId = null;

function getLinks(doc) {
  // Support both old single-url format and new multi-link format
  if (doc.links && doc.links.length) return doc.links;
  if (doc.url) return [{ label: "", url: doc.url }];
  return [];
}

function makeCard(doc, cat) {
  const card = document.createElement("div");
  card.className = "card";
  card.dataset.id = doc.id;
  card.draggable = true;

  const sc = STATUS_STYLES[doc.status] || STATUS_STYLES.Done;
  const links = getLinks(doc);
  const linksHtml = links.length
    ? links.map(l => `<a href="${escHtml(l.url)}" target="_blank"
        style="color:${cat.color};font-size:11px;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"
        onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'"
        >${l.label ? escHtml(l.label) + ' ↗' : escHtml(l.url.replace(/^https?:\/\//, '').substring(0, 40)) + ' ↗'}</a>`).join("")
    : `<div class="card-nolink">No link added yet</div>`;

  card.innerHTML = `
    <div class="card-top">
      <div class="card-title">${escHtml(doc.title)}</div>
      <span class="status-badge" style="color:${sc.text};background:${sc.bg};border:1px solid ${sc.border}">${doc.status.toUpperCase()}</span>
    </div>
    ${doc.note ? `<div class="card-note">${escHtml(doc.note)}</div>` : ""}
    <div class="card-links">${linksHtml}</div>
    <button class="edit-btn">edit</button>
  `;

  card.querySelector(".edit-btn").addEventListener("click", () => openEditForm(card, doc, cat));
  card.addEventListener("dragstart", e => {
    draggedId = doc.id;
    e.dataTransfer.effectAllowed = "move";
    setTimeout(() => card.classList.add("dragging"), 0);
  });
  card.addEventListener("dragend", () => {
    draggedId = null;
    document.querySelectorAll(".card.dragging").forEach(c => c.classList.remove("dragging"));
    document.querySelectorAll(".drop-indicator").forEach(el => el.classList.remove("visible"));
  });
  return card;
}

function getCardInsertIdx(col, clientY) {
  const cards = [...col.querySelectorAll(".card:not(.dragging)")];
  for (let i = 0; i < cards.length; i++) {
    const rect = cards[i].getBoundingClientRect();
    if (clientY < rect.top + rect.height / 2) return i;
  }
  return cards.length;
}

function setupColumnDrop(col, catId) {
  col.addEventListener("dragover", e => {
    if (!draggedId) return;
    e.preventDefault();
    col.querySelectorAll(".drop-indicator").forEach(el => el.classList.remove("visible"));
    const indicators = [...col.querySelectorAll(".drop-indicator")];
    const idx = getCardInsertIdx(col, e.clientY);
    if (indicators[idx]) indicators[idx].classList.add("visible");
  });
  col.addEventListener("dragleave", e => {
    if (!col.contains(e.relatedTarget)) col.querySelectorAll(".drop-indicator").forEach(el => el.classList.remove("visible"));
  });
  col.addEventListener("drop", e => {
    if (!draggedId) return;
    e.preventDefault();
    col.querySelectorAll(".drop-indicator").forEach(el => el.classList.remove("visible"));
    const insertIdx = getCardInsertIdx(col, e.clientY);
    const draggedDoc = docs.find(d => d.id === draggedId);
    if (!draggedDoc) return;
    docs = docs.filter(d => d.id !== draggedId);
    draggedDoc.category = catId;
    const catDocs = docs.filter(d => d.category === catId);
    if (insertIdx >= catDocs.length) {
      const last = catDocs[catDocs.length - 1];
      const at = last ? docs.findIndex(d => d.id === last.id) + 1 : docs.length;
      docs.splice(at, 0, draggedDoc);
    } else {
      docs.splice(docs.findIndex(d => d.id === catDocs[insertIdx].id), 0, draggedDoc);
    }
    save(); render();
  });
}

let draggedColId = null;

function setupColumnHeaderDrag(col, catId) {
  const header = col.querySelector(".col-header");
  header.draggable = true;
  header.addEventListener("dragstart", e => {
    draggedColId = catId;
    e.dataTransfer.effectAllowed = "move";
    setTimeout(() => col.classList.add("col-dragging"), 0);
  });
  header.addEventListener("dragend", () => {
    draggedColId = null;
    document.querySelectorAll(".column").forEach(c => c.classList.remove("col-dragging", "col-drop-left", "col-drop-right"));
  });
  col.addEventListener("dragover", e => {
    if (!draggedColId || draggedColId === catId) return;
    e.preventDefault();
    document.querySelectorAll(".column").forEach(c => c.classList.remove("col-drop-left", "col-drop-right"));
    const rect = col.getBoundingClientRect();
    col.classList.add(e.clientX < rect.left + rect.width / 2 ? "col-drop-left" : "col-drop-right");
  });
  col.addEventListener("dragleave", e => {
    if (!col.contains(e.relatedTarget)) col.classList.remove("col-drop-left", "col-drop-right");
  });
  col.addEventListener("drop", e => {
    if (!draggedColId || draggedColId === catId) return;
    e.preventDefault();
    col.classList.remove("col-drop-left", "col-drop-right");
    const rect = col.getBoundingClientRect();
    const insertBefore = e.clientX < rect.left + rect.width / 2;
    const fromIdx = CATEGORIES.findIndex(c => c.id === draggedColId);
    if (fromIdx === -1) return;
    const [moved] = CATEGORIES.splice(fromIdx, 1);
    const newTo = CATEGORIES.findIndex(c => c.id === catId);
    CATEGORIES.splice(insertBefore ? newTo : newTo + 1, 0, moved);
    save(); render();
  });
}

function makeLinkRow(link, catColor) {
  const row = document.createElement("div");
  row.className = "link-row";
  row.style.cssText = "display:flex;gap:5px;align-items:center;";
  row.innerHTML = `
    <input class="form-input small link-label" placeholder="Label (e.g. Contract)" value="${escHtml(link.label)}" style="flex:1;" />
    <input class="form-input small link-url" placeholder="URL" value="${escHtml(link.url)}" style="flex:2;" />
    <button class="btn-delete" style="padding:5px 8px;flex-shrink:0;" title="Remove">✕</button>
  `;
  row.querySelector(".btn-delete").addEventListener("click", () => row.remove());
  return row;
}

function openEditForm(card, doc, cat) {
  const form = document.createElement("div");
  form.className = "edit-form";
  form.innerHTML = `
    <input class="form-input" placeholder="Document title" value="${escHtml(doc.title)}" />
    <input class="form-input small" placeholder="Quick note (optional)" value="${escHtml(doc.note)}" />
    <select class="form-input small">
      ${STATUSES.map(s => `<option${s === doc.status ? " selected" : ""}>${s}</option>`).join("")}
    </select>
    <div class="links-section">
      <div class="links-label" style="font-size:10px;color:#aaa;letter-spacing:0.04em;margin-bottom:4px;">LINKS</div>
      <div class="links-list"></div>
      <button class="add-link-btn" style="margin-top:5px;background:none;border:1px dashed #d8d3ca;color:#aaa;border-radius:5px;padding:5px 10px;font-size:10px;width:100%;letter-spacing:0.04em;">+ ADD LINK</button>
    </div>
    <div class="form-row">
      <button class="btn-save" style="background:${cat.color}">Save</button>
      <button class="btn-cancel">Cancel</button>
      <button class="btn-delete-card">✕ Delete</button>
    </div>
  `;

  const titleIn = form.querySelector("input");
  const noteIn = form.querySelectorAll("input")[1];
  const statusSel = form.querySelector("select");
  const linksList = form.querySelector(".links-list");

  // Populate existing links
  const existingLinks = getLinks(doc);
  existingLinks.forEach(l => linksList.appendChild(makeLinkRow(l, cat.color)));

  form.querySelector(".add-link-btn").addEventListener("click", () => {
    linksList.appendChild(makeLinkRow({ label: "", url: "" }, cat.color));
    linksList.lastChild.querySelector(".link-url").focus();
  });

  form.querySelector(".btn-save").addEventListener("click", () => {
    const idx = docs.findIndex(d => d.id === doc.id);
    if (idx !== -1) {
      const linkRows = [...linksList.querySelectorAll(".link-row")];
      const links = linkRows
        .map(r => ({ label: r.querySelector(".link-label").value.trim(), url: r.querySelector(".link-url").value.trim() }))
        .filter(l => l.url);
      docs[idx] = { ...docs[idx], title: titleIn.value, note: noteIn.value, status: statusSel.value, links, url: "" };
      save(); render();
    }
  });
  form.querySelector(".btn-cancel").addEventListener("click", () => render());
  form.querySelector(".btn-delete-card").addEventListener("click", () => {
    if (confirm(`Delete "${doc.title}"?`)) { docs = docs.filter(d => d.id !== doc.id); save(); render(); }
  });
  card.replaceWith(form);
}

function makeAddForm(catId, cat) {
  const form = document.createElement("div");
  form.className = "add-form";
  form.innerHTML = `
    <input class="form-input" placeholder="Document title *" />
    <input class="form-input small" placeholder="Quick note (optional)" />
    <select class="form-input small">
      ${STATUSES.map(s => `<option${s === "Draft" ? " selected" : ""}>${s}</option>`).join("")}
    </select>
    <div class="links-section">
      <div class="links-label" style="font-size:10px;color:#aaa;letter-spacing:0.04em;margin-bottom:4px;">LINKS</div>
      <div class="links-list"></div>
      <button class="add-link-btn" style="margin-top:5px;background:none;border:1px dashed #d8d3ca;color:#aaa;border-radius:5px;padding:5px 10px;font-size:10px;width:100%;letter-spacing:0.04em;">+ ADD LINK</button>
    </div>
    <div class="form-row">
      <button class="btn-save" style="background:${cat.color}">Add Doc</button>
      <button class="btn-cancel">Cancel</button>
    </div>
  `;
  const titleIn = form.querySelector("input");
  const noteIn = form.querySelectorAll("input")[1];
  const statusSel = form.querySelector("select");
  const linksList = form.querySelector(".links-list");

  // Start with one empty link row
  linksList.appendChild(makeLinkRow({ label: "", url: "" }, cat.color));

  form.querySelector(".add-link-btn").addEventListener("click", () => {
    linksList.appendChild(makeLinkRow({ label: "", url: "" }, cat.color));
    linksList.lastChild.querySelector(".link-url").focus();
  });

  setTimeout(() => titleIn.focus(), 50);
  form.querySelector(".btn-save").addEventListener("click", () => {
    if (!titleIn.value.trim()) return;
    const linkRows = [...linksList.querySelectorAll(".link-row")];
    const links = linkRows
      .map(r => ({ label: r.querySelector(".link-label").value.trim(), url: r.querySelector(".link-url").value.trim() }))
      .filter(l => l.url);
    docs.push({ id: Date.now().toString(), category: catId, title: titleIn.value.trim(), note: noteIn.value.trim(), status: statusSel.value, links, url: "" });
    save(); render();
  });
  form.querySelector(".btn-cancel").addEventListener("click", () => render());
  return form;
}

function render() {
  updateFilters();
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  CATEGORIES.forEach(cat => {
    const catDocs = docs.filter(d => d.category === cat.id && (filterStatus === "All" || d.status === filterStatus));
    const col = document.createElement("div");
    col.className = "column";
    col.style.setProperty("--cat-color", cat.color);
    col.style.setProperty("--cat-color-bg", cat.color + "12");

    const header = document.createElement("div");
    header.className = "col-header";
    header.style.setProperty("--cat-color", cat.color);
    header.innerHTML = `
      <div class="col-header-left">
        <span class="col-icon" style="color:${cat.color}">${cat.icon}</span>
        <span class="col-label">${cat.label}</span>
      </div>
      <span class="col-count" style="background:${cat.color}">${catDocs.length}</span>
    `;
    col.appendChild(header);

    catDocs.forEach(doc => {
      const ind = document.createElement("div");
      ind.className = "drop-indicator";
      col.appendChild(ind);
      col.appendChild(makeCard(doc, cat));
    });
    const trailingInd = document.createElement("div");
    trailingInd.className = "drop-indicator";
    col.appendChild(trailingInd);

    const addBtn = document.createElement("button");
    addBtn.className = "add-btn";
    addBtn.textContent = "+ ADD DOC";
    addBtn.addEventListener("click", () => addBtn.replaceWith(makeAddForm(cat.id, cat)));
    col.appendChild(addBtn);

    setupColumnDrop(col, cat.id);
    setupColumnHeaderDrag(col, cat.id);
    grid.appendChild(col);
  });

  document.getElementById("doc-count").textContent = `${docs.length} DOCUMENTS TRACKED`;
}

function escHtml(str) {
  return (str || "").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

load();
setDate();
setQuote();
buildFilters();
render();
</script>
</body>
</html>
